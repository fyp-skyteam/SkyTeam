<!DOCTYPE html>
<!--
  Copyright 2011 Google Inc. All Rights Reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at bac

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
  <head>
    <meta charset="UTF-8">

    <title>Fusion Tables API Example: Advanced Visualization</title>

    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript"
        src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<link href="https://developers.google.com/fusiontables/docs/samples/style/default.css"
        rel="stylesheet" type="text/css">

    <style type="text/css">
      #map-canvas {
        width: auto;
      }

      #visualization {
        float: right;
      }

      #legend {
        background: #FFF;
        margin: 10px;
        padding: 5px;
        width: 150px;
      }

      #legend p {
        font-weight: bold;
        margin-top: 3px;
      }

      #legend div {
        clear: both;
      }

      .color {
        height: 12px;
        width: 12px;
        margin-right: 3px;
        float: left;
        display: block;
      }

      .high {
        color: #F00;
      }

      .medium {
        color: #0F0;
      }

      .low {
        color: #00F;
      }

      .high, .medium, .low {
        font-weight: bold;
      }
    </style>

    <script type="text/javascript">
      google.load('visualization', '1', { packages: ['corechart'] });

      /**
       * Sector type mapped to a style rule.
       * @type {Object}
       * @const
       */
       
       var LAYER_STYLES = {
        'Flood': {
          'min': 0,
          'max': 100,
          'colors': [
             '#d0e0e3',
             '#a2c4c9',
             '#76a5af',
             '#45818e',
             '#134f5c'
          ]
        },
        'Fire': {
          'min': 0,
          'max': 100,
          'colors': [
			'#f4cccc',
			'#ea9999',
			'#e06666',
			'#cc0000',
			'#990000'
           
          ]
        },
        'Earthquake': {
          'min': 0,
          'max': 100,
          'colors': [
            '#d9d2e9',
            '#b4a7d6',
            '#8e7cc3',
            '#674ea7',
            '#351c75'
          ]
        },
        'Total': {
            'min': 0,
            'max': 100,
            'colors': [
              '#C4FEA8',
              '#89FF89',
              '#1FFE1E',
              '#15BB00',
              '#157100'
           ]
        }
      }

      function initialize() {
        var sector = 'Flood';
        var map = new google.maps.Map(document.getElementById('map-canvas'), {
            center: new google.maps.LatLng(4.210484, 101.975766),
            zoom: 5,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            zoomControlOptions: {
              style: google.maps.ZoomControlStyle.SMALL
            },
          });
        var layer = new google.maps.FusionTablesLayer();
        updateLayerQuery(layer, sector);
        layer.setMap(map);
        createLegend(map, sector);
        styleLayerBySector(layer, sector);
        styleMap(map);
        drawVisualization('Johor');

        google.maps.event.addListener(layer, 'click', function(e) {
          var county = e.row['name'].value;
          drawVisualization(county);

          var risk = e.row['2013'].value;
          if (risk > 66) {
            e.infoWindowHtml = '<p class="high">High Risk!</p>';
          } else if (risk > 33) {
            e.infoWindowHtml = '<p class="medium">Medium Risk</p>';
          } else {
            e.infoWindowHtml = '<p class="low">Low Risk</p>';
          }
        });

        google.maps.event.addDomListener(document.getElementById('sector'),
            'change', function() {
              sector = this.value;
              updateLayerQuery(layer, sector);
              styleLayerBySector(layer, sector);
              updateLegend(sector);
            });

        google.maps.event.addDomListener(document.getElementById('county'),
            'change', function() {
              var county = this.value;
              updateLayerQuery(layer, sector, county);
              drawVisualization(county);
            });
      }
       
      function updateLayerQuery(layer, sector, county) {
        var where = "'Risk Factor' = '" + sector + "'";
        if (county) {
          where += " AND 'name' = '" + county + "'";
        }
        layer.setOptions({
          query: {
            select: 'geometry',
            from: '1n6YmqLeeb7eXX0TqV2riidchOQ7nV-S2WIB8xfg',
            where: where
          }
        });
      }

      function createLegend(map, sector) {
        var legendWrapper = document.createElement('div');
        legendWrapper.id = 'legendWrapper';
        legendWrapper.index = 1;
        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(
            legendWrapper);
        legendContent(legendWrapper, sector);
      }

      function legendContent(legendWrapper, sector) {
        var legend = document.createElement('div');
        legend.id = 'legend';

        var title = document.createElement('p');
        title.innerHTML = sector + ' Risk Probability';
        legend.appendChild(title);

        var layerStyle = LAYER_STYLES[sector];
        var colors = layerStyle.colors;
        var minNum = layerStyle.min;
        var maxNum = layerStyle.max;
        var step = (maxNum - minNum) / colors.length;
        for (var i = 0; i < colors.length; i++) {
          var legendItem = document.createElement('div');

          var color = document.createElement('div');
          color.setAttribute('class', 'color');
          color.style.backgroundColor = colors[i];
          legendItem.appendChild(color);

          var newMin = minNum + step * i;
          var newMax = newMin + step;
          var minMax = document.createElement('span');
          minMax.innerHTML = newMin + ' - ' + newMax;
          legendItem.appendChild(minMax);

          legend.appendChild(legendItem);
        }

        legendWrapper.appendChild(legend);
      }

      function updateLegend(sector) {
        var legendWrapper = document.getElementById('legendWrapper');
        var legend = document.getElementById('legend');
        legendWrapper.removeChild(legend);
        legendContent(legendWrapper, sector);
      }

      function styleLayerBySector(layer, sector) {
        var layerStyle = LAYER_STYLES[sector];
        var colors = layerStyle.colors;
        var minNum = layerStyle.min;
        var maxNum = layerStyle.max;
        var step = (maxNum - minNum) / colors.length;

        var styles = new Array();
        for (var i = 0; i < colors.length; i++) {
          var newMin = minNum + step * i;
          styles.push({
            where: generateWhere(newMin, sector),
            polygonOptions: {
              fillColor: colors[i],
              fillOpacity: 1
            }
          });
        }
        layer.set('styles', styles);
      }

      function generateWhere(minNum, sector) {
        var whereClause = new Array();
        whereClause.push("'Risk Factor' = '");
        whereClause.push(sector);
        whereClause.push("' AND '2013' >= ");
        whereClause.push(minNum);
        return whereClause.join('');
      }

      function styleMap(map) {
        var style = [{
          featureType: 'all',
          stylers: [{
            saturation: -99
          }]
        }, {
          featureType: 'poi',
          stylers: [{
            visibility: 'off'
          }]
        }, {
          featureType: 'road',
          stylers: [{
            visibility: 'off'
          }]
        }];

        var styledMapType = new google.maps.StyledMapType(style, {
          map: map,
          name: 'Styled Map'
        });
        map.mapTypes.set('map-style', styledMapType);
        map.setMapTypeId('map-style');
      }

      function drawVisualization(county) {
        google.visualization.drawChart({
          containerId: "visualization",
          dataSourceUrl: "http://www.google.com/fusiontables/gvizdata?tq=",
          query: "SELECT 'Risk Factor','2006','2007','2008','2009','2010','2011','2012','2013' " +
              "FROM 1n6YmqLeeb7eXX0TqV2riidchOQ7nV-S2WIB8xfg WHERE name = '" + county + "'",
          chartType: "ColumnChart",
          options: {
            title: county,
            height: 400,
            width: 400
          }
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="visualization"></div>
    <div id="map-canvas"></div>
    <form>
      <label>Sector </label>
      <select id="sector">
        <option value="Flood">Flood</option>
        <option value="Fire">Fire</option>
        <option value="Earthquake">Earthquake</option>
        <option value="Total">Total</option>
      </select>
      <label>County</label>
      <select id="county">
        <option value="Johor">Johor</option>
        <option value="Kedah">Kedah</option>
        <option value="Kelantan">Kelantan</option>
        <option value="Melaka">Melaka</option>
        <option value="Negeri Sembilan">Negeri Sembilan</option>
        <option value="Pahang">Pahang</option>
        <option value="Perak">Perak</option>
        <option value="Perlis">Perlis</option>
        <option value="Pulau Pinang">Pulau Pinang</option>
        <option value="Sabah">Sabah</option>
        <option value="Sarawak">Sarawak</option>
        <option value="Selangor">Selangor</option>
        <option value="Terengganu">Terengganu</option>
        <option value="Wilayah Persekutuan">Wilayah Persekutuan</option>
      </select>
    </form>
  </body>
</html>